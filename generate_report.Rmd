---
title: "JFS Monthly Report"
author: "Erika Rasnick"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    df_print: kable
params: 
  d: data
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(tidyverse)
library(sf)
library(knitr)
library(tmap)
tmap_mode('view')
```

```{r}
d <- params$d
```

# Overall Summary

```{r}
geocode_summary <- d %>% 
  group_by(is.na(lat)) %>% 
  tally() %>% 
  mutate(pct = round(n/sum(n)*100,1))
```

**Number of intakes:** `r nrow(d)`

**Number successfully geocoded:** `r geocode_summary$n[1]` (`r geocode_summary$pct[1]`%)

```{r}
dep_summary <- d %>% 
  filter(!is.na(lat)) %>% 
  group_by(SCREENING_DECISION) %>% 
  summarize(mean_dep = round(mean(dep_index, na.rm = T),2), 
            sd_dep = round(sd(dep_index, na.rm = T), 1))

d %>% 
  filter(!is.na(lat)) %>% 
  group_by(SCREENING_DECISION) %>% 
  tally() %>% 
  mutate(pct = round(n/sum(n)*100,1),
         `N (%)` = glue::glue('{n} ({pct}%)')) %>% 
  left_join(dep_summary, by = 'SCREENING_DECISION') %>% 
  mutate(mean_sd = glue::glue('{mean_dep} ({sd_dep})')) %>% 
  select(Decision = SCREENING_DECISION, `N (%)`, `Deprivation Index Mean (sd) ` = mean_sd)
```

# Neighborhood Summary

```{r}
tract_to_neighborhood <- readRDS('/app/tract_to_neighborhood.rds')

d <- d  %>%
  select(INTAKE_ID:fips_tract_id) %>% 
  filter(!is.na(lat)) %>% 
  left_join(tract_to_neighborhood, by='fips_tract_id')

intakes_neighborhood <- d %>% 
  group_by(neighborhood) %>% 
  summarize(n_intakes = n())

screen_neighborhood <- d %>% 
  group_by(neighborhood, SCREENING_DECISION) %>% 
  tally() %>% 
  filter(SCREENING_DECISION == 'SCREENED IN') %>% 
  mutate(n_screen_in = n) %>% 
  select(-n, -SCREENING_DECISION) %>% 
  left_join(intakes_neighborhood, by = 'neighborhood')

neighborhood_shp <- readRDS('/app/ham_neighborhoods_dep_index_shp.rds')

d_neighborhood <- neighborhood_shp %>% 
  left_join(screen_neighborhood, by = 'neighborhood') %>% 
  mutate(n_intakes_per_1000 = n_intakes/pop_under_18*1000,
         n_screened_in_per_1000 = n_screen_in/pop_under_18*1000,
         fractional_screen_in = n_screened_in_per_1000/n_intakes_per_1000) %>% 
  select(neighborhood, n_intakes, n_intakes_per_1000, n_screen_in, n_screened_in_per_1000,
         fractional_screen_in, city, dep_index, pop_under_18)
  
# d_neighborhood %>%  
#   st_drop_geometry() %>% 
#   select(neighborhood, n_screened_in_per_1000, dep_index)
```


```{r}
d_neighborhood %>% 
  mutate(neighborhood = fct_reorder(neighborhood, n_intakes_per_1000, .desc = FALSE)) %>% 
  top_n(n = 10, wt = n_intakes_per_1000) %>% 
  ggplot(aes(x = neighborhood, y = n_intakes_per_1000, fill = n_intakes_per_1000)) +
    geom_bar(stat='identity') +
    labs(title = 'Intake Rates by Neighborhood',
          y = 'Number of Calls Per 1000 Population under 18') +
    theme(axis.title.y = element_blank()) +
  scale_fill_viridis_c() +
  theme(legend.position = "none") +
  coord_flip()
```

```{r}
d_neighborhood %>% 
  mutate(neighborhood = fct_reorder(neighborhood, n_screened_in_per_1000, .desc = FALSE)) %>% 
  top_n(n = 10, wt = n_screened_in_per_1000) %>% 
  ggplot(aes(x = neighborhood, y = n_screened_in_per_1000, fill = n_screened_in_per_1000)) +
    geom_bar(stat='identity') +
    labs(title = 'Screen-In Rates by Neighborhood',
          y = 'Number of Calls Screened In Per 1000 Population under 18') +
    theme(axis.title.y = element_blank()) +
  scale_fill_viridis_c() +
  theme(legend.position = "none") +
    coord_flip()
```

```{r}
d_neighborhood %>% 
  mutate(neighborhood = fct_reorder(neighborhood, fractional_screen_in, .desc = FALSE)) %>% 
  top_n(n = 10, wt = fractional_screen_in) %>% 
  ggplot(aes(x = neighborhood, y = fractional_screen_in, fill = fractional_screen_in)) +
    geom_bar(stat='identity') +
    labs(title = 'Screen-Ins per Intake by Neighborhood',
          y = 'Number of Screen-Ins Per Intake') +
    theme(axis.title.y = element_blank()) +
  scale_fill_viridis_c() +
  theme(legend.position = "none") +
    coord_flip()
```


```{r, fig.width = 10, fig.height=8}
tm_basemap("CartoDB.Positron") +
  tm_shape(d_neighborhood) +
  tm_polygons(col = c('n_intakes_per_1000',
                      'n_screened_in_per_1000',
                      'fractional_screen_in',
                      'dep_index'),
              title = c('Intake Rate',
                        'Screen-In Rate',
                        'Fractional Screen-In',
                        'Deprivation Index'),
              alpha = 0.8,
              palette = 'viridis') +
  tm_scale_bar() +
  tm_layout(frame = FALSE,
            asp = 4)
```
